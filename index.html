<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>정군산 전투 군기 시뮬레이터</title>
<style>
  body { 
    margin:0; background:#111; color:#fff; font-family:sans-serif; 
    display:flex; flex-direction:column; align-items:center;
    overflow-x: hidden; touch-action: none;
    -webkit-user-select:none; -moz-user-select:none; -ms-user-select:none; user-select:none;
    padding-bottom: 120px; 
  }
  
  .top-buttons { margin:15px; display: flex; justify-content: center; width: 100%; flex-wrap: nowrap; }
  button { 
    margin:0 3px; padding:10px 15px; cursor:pointer; background:#333; color:#fff; 
    border:1px solid #555; border-radius:5px; font-weight:bold; font-size:13px;
    white-space: nowrap; -webkit-tap-highlight-color: transparent;
  }
  button:hover { background: #444; }

  canvas { 
    background:#111; display:block; margin:0 auto; border:1px solid #333; cursor: crosshair; 
    max-width: 98%; height: auto; touch-action: none;
    -webkit-touch-callout: none;
  }

  .effects { 
    width: 98%; max-width: 1100px; display:flex; flex-direction: row; 
    justify-content: space-between; margin:15px 0; border-top:1px solid #444; padding-top:20px; 
    gap: 8px;
  }
  .effect { 
    width: 33.3%; text-align:left; background: rgba(255,255,255,0.05); 
    padding: 10px; border-radius: 10px; box-sizing: border-box; border: 1px solid #333;
    transition: all 0.3s ease; overflow: hidden;
  }
  
  .effect .title { 
    font-size:14px; color:#fff; margin-bottom:10px; font-weight:bold; text-align:center; 
    border-bottom: 2px solid #555; padding-bottom: 5px; cursor: pointer;
  }

  @media (max-width: 768px) {
    .effect.collapsed { min-height: 45px !important; height: 45px !important; }
    .effect.collapsed .effect-content { display: none; }
    .effect .title::after { content: ' ▼'; font-size: 10px; opacity: 0.5; }
    .effect.collapsed .title::after { content: ' ▲'; }
    .opt-name { font-size: 13px !important; }
    .opt-desc { font-size: 12px !important; }
  }

  .formation-base { font-size: 13px; font-weight: bold; margin-bottom: 8px; text-align: center; }
  .opt-item { margin-top:8px; line-height:1.4; border-left: 3px solid #666; padding-left: 8px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 0 5px 5px 0; }
  .opt-name { font-weight: bold; font-size: 14px; color: #fff; display: block; }
  .opt-desc { font-size: 12px; color: #ddd; display: block; }

  .bottom-buttons { 
    width: 98%; max-width: 1100px; margin:10px 0 20px 0; 
    display: flex; flex-direction: row; justify-content: center; align-items: center; 
    flex-wrap: nowrap; gap: 4px;
  }
  .bottom-buttons button { padding: 8px 10px; font-size: 12px; flex-shrink: 0; }
  .status-badge { padding: 8px 12px; background: #222; border: 2px solid #fff; border-radius: 8px; color: #fff; font-weight: bold; font-size: 13px; }
  
  #palette { background:#181818; border-top:1px solid #333; margin-top: 10px; }
</style>
</head>
<body oncontextmenu="return false">

<div class="top-buttons">
  <button onclick="setBoard('안행진')">안행진</button>
  <button onclick="setBoard('현양진')">현양진</button>
  <button onclick="setBoard('추형진')">추형진</button>
  <button onclick="setBoard('구형진')">구형진</button>
</div>

<canvas id="board" width="1100" height="360"></canvas>

<div class="effects">
  <div class="effect" id="box-left">
    <div class="title" style="color:#2ecc71;" onclick="toggleEffect('box-left')">좌측</div>
    <div id="effect-left" class="effect-content"></div>
  </div>
  <div class="effect" id="box-center">
    <div class="title" style="color:#e74c3c;" onclick="toggleEffect('box-center')">중심</div>
    <div id="effect-center" class="effect-content"></div>
  </div>
  <div class="effect" id="box-right">
    <div class="title" style="color:#3498db;" onclick="toggleEffect('box-right')">우측</div>
    <div id="effect-right" class="effect-content"></div>
  </div>
</div>

<div class="bottom-buttons">
  <button onclick="selectCategory('군기')">군기</button>
  <button onclick="selectCategory('시설A')">시설A</button>
  <button onclick="selectCategory('시설B')">시설B</button>
  <span style="color: #444; font-size: 18px;">|</span>
  <button onclick="undoLast()" style="background:#555;">뒤로</button>
  <button onclick="clearBoard()" style="background:#c0392b; border:none;">초기화</button>
  <div class="status-badge" id="defense-score">방어치 : 0</div>
</div>

<canvas id="palette" width="1100" height="220"></canvas>

<script>
const itemImages = {
  "목책": "https://i.imgur.com/nVMAJ2m.png", "치차": "https://i.imgur.com/afcSPeq.png", "울타리": "https://i.imgur.com/YcOXVbc.png",
  "깃발 수레": "https://i.imgur.com/JyTTiw9.png", "의장": "https://i.imgur.com/4lBRS9S.png", "호교": "https://i.imgur.com/hFnnrv4.png",
  "전고": "https://i.imgur.com/Kze6RsC.png", "목수": "https://i.imgur.com/FceMagP.png", "파장탑": "https://i.imgur.com/B2SIC96.png",
  "인화차": "https://i.imgur.com/U9Oezgp.png", "목우유마": "https://i.imgur.com/VGm5noB.png", "경차": "https://i.imgur.com/y5ampJD.png",
  "대항영": "https://i.imgur.com/elTTSPe.png", "연영": "https://i.imgur.com/eawBuwS.png", "사다리차": "https://i.imgur.com/IMHQI2u.png",
  "충차": "https://i.imgur.com/HE7GYNM.png", "검문소": "https://i.imgur.com/NVJvfMC.png", "벽력차": "https://i.imgur.com/04eZJwo.png",
  "장군 막사": "https://i.imgur.com/tvh1gqs.png", "말뚝": "https://i.imgur.com/gpcqzQy.png", "쇠사슬": "https://i.imgur.com/RubufVY.png",
  "선등영": "https://i.imgur.com/LiDfbfG.png", "초소": "https://i.imgur.com/XkPOhd0.png", "호분영": "https://i.imgur.com/um5SUWc.png"
};

const hanjaMap = {
    "출격기": "砺戈旗", "선갑기": "缮甲旗", "양위기": "扬威旗", "무위기": "武威旗", "모위기": "谋威旗", "무비기": "武备旗", 
    "모비기": "谋备旗", "지원기": "援攻旗", "수호기": "护守旗", "정군기": "整军旗", "경계기": "哨戒旗", "경장기": "轻装旗",
    "의장": "医帐", "호교": "辘桥", "목책": "栅栏", "깃발 수레": "旌轩", "치차": "辎车", "울타리": "拒马",
    "전고": "战鼓", "파장탑": "破障塔", "인화차": "引火车", "목수": "木兽", "연영": "连营", "경차": "轻车",
    "목우유마": "木牛流马", "대항영": "御敌营", "검문소": "门岗", "충차": "冲车", "벽력차": "霹雳车", "사다리차": "搭天车",
    "장군 막사": "虎帐", "쇠사슬": "铁索", "말뚝": "暗桩", "선등영": "先登营", "호분영": "虎贪营", "초소": "哨岗"
};

const itemOptions = {
  "출격기": "병종 S, 주는 피해 +3% 받는 피해 +3%", "선갑기": "병종 S, 주는 피해 -3% 받는 피해 -3%", "양위기": "성씨 장수 존재 시 첫 턴 감면 -15%, 매턴 5% 감소", "무위기": "주는 피해 +5%, 무력 +18", "모위기": "주는 피해 +5%, 지력 +15", "무비기": "받는 피해 -4%, 통솔 +30", "모비기": "받는 피해 -4%, 지력 +15", "지원기": "주는 피해 -5%, 동료가 주는 피해 +6%", "수호기": "주는 피해 -5%, 동료가 받는 피해 -5%", "정군기": "전투 후 자신의 부상병 65% 회복", "경계기": "통솔 +40, 회심/계책 피해 30% 감소", "경장기": "통솔 +40, 지속 상태 피해 30% 감소",
  "목책": "우군 중 최고 병력 장수가 피해 20% 분담", "치차": "자신에게 1회 무기 피해 , 우군 병력 회복", "울타리": "피해 받을 때마다 적군 피해(턴당 2회)", "깃발 수레": "피해 받을 때마다 주장 속성 증가", "전고": "액티브 실패 시 재발동 시도", "목수": "적 치료 금지 또는 연소 부여", "파장탑": "디버프 2회 부여 시 방어 획득", "인화차": "지속 피해 +6%, 필중 획득", "대항영": "초과 치료량 기반 적군 피해", "연영": "치료 후 감면 및 피해 증가", "목우유마": "홀수 턴 아군 2명 치료", "경차": "누적 치료량 기반 적군 피해", "사다리차": "6,7턴 회심/계책 대폭 강화", "충차": "턴당 회심/계책 확률 누적", "검문소": "회심/계책 시 아군 치료", "벽력차": "짝수 턴 적군 피해 및 피해율 증가", "의장": "3,6턴 회복 및 35% 정화", "호교": "전법 발동 시 속성 중첩 증가",
  "장군 막사": "모든 속성 +5", "말뚝": "짝수 턴 받는 피해 -5%", "쇠사슬": "통솔 +20, 피해 40% 전이", "선등영": "속도 +15, 주는 피해 +2%", "초소": "600이상의 피해 받을 때마다 감면 중첩", "호분영": "3,6턴 단일 적군 피해"
};

const loadedImages = {};
Object.keys(itemImages).forEach(name => {
  const img = new Image(); img.src = itemImages[name];
  img.onload = () => { loadedImages[name] = img; renderBoard(); renderPalette(); };
});

var boardCanvas, bctx, paletteCanvas, pctx;
var HEX_SIZE = 28; var HEX_W = Math.sqrt(3) * HEX_SIZE; var HEX_H = 2 * HEX_SIZE; var ROW_H = HEX_H * 0.75;
var colors = {"초":"#2ecc71","파":"#3498db","빨":"#e74c3c","좌":"#555","우":"#555","중":"#555"};
var currentBoard = "안행진", currentCategory = "군기", placedItems = [], draggingItem = null, isMovingFromBoard = false;

var formationEffects = { "안행진":["주는 피해 +3%","병력 회복 (15%)","받는 피해 -3%"], "현양진":["전법 확률 +2%","전법 피해 +3%","제어 대상 피해 +4%"], "추형진":["치료 효과 +3%","받는 피해 -3%","받는 치료 +4%"], "구형진":["주는/받는 피해 -4%","회심 피해 +4%","의병 획득"] };
var boards = {
  "안행진":[["X","초","초","X","X","X","파","파","X"],["X","초","초","초","초","파","파","파","파","X"],["X","초","좌","초","빨","파","우","파","X"],["X","X","초","초","빨","빨","파","파","X","X"],["X","X","X","빨","중","빨","X","X","X"],["X","X","X","빨","빨","빨","빨","X","X","X"]],
  "현양진":[["X","X","X","X","파","파","파","X","X"],["X","X","초","초","초","파","우","파","X","X"],["X","초","좌","초","파","파","파","X","X"],["X","X","초","초","빨","파","X","X","X","X"],["X","초","초","빨","빨","빨","빨","X","X"],["X","X","X","X","빨","중","빨","X","X","X"]],
  "추형진":[["X","X","X","빨","빨","X","X","X","X"],["X","X","X","빨","중","빨","X","X","X","X"],["X","X","빨","빨","빨","빨","X","X","X"],["X","X","초","초","빨","파","파","X","X","X"],["X","초","초","초","파","파","파","X","X"],["X","초","초","좌","X","우","파","파","X","X"]],
  "구형진":[["X","X","초","초","X","파","파","X","X"],["X","X","초","초","초","파","우","파","X","X"],["X","초","좌","초","파","파","파","파","X"],["X","X","초","초","빨","파","빨","X","X","X"],["X","X","X","빨","중","빨","빨","X","X"],["X","X","X","빨","빨","빨","X","X","X","X"]]
};

var commonA = [{name:"의장",type:"3-2",cat:"시설A"},{name:"호교",type:"3-1",cat:"시설A"}];
var boardSpecificA = {
  "안행진":[{name:"목책",type:"3-3",cat:"시설A"},{name:"치차",type:"3-2",cat:"시설A"},{name:"울타리",type:"3-1",cat:"시설A"},{name:"깃발 수레",type:"3-3",cat:"시설A"}],
  "현양진":[{name:"전고",type:"3-2",cat:"시설A"},{name:"목수",type:"3-1",cat:"시설A"},{name:"파장탑",type:"3-3",cat:"시설A"},{name:"인화차",type:"3-1",cat:"시설A"}],
  "추형진":[{name:"대항영",type:"3-3",cat:"시설A"},{name:"연영",type:"3-1",cat:"시설A"},{name:"목우유마",type:"3-2",cat:"시설A"},{name:"경차",type:"3-2",cat:"시설A"}],
  "구형진":[{name:"사다리차",type:"3-2",cat:"시설A"},{name:"충차",type:"3-3",cat:"시설A"},{name:"검문소",type:"3-1",cat:"시설A"},{name:"벽력차",type:"3-3",cat:"시설A"}]
};
var categoryItems = {
  "군기":["출격기","선갑기","양위기","무위기","모위기","무비기","모비기","지원기","수호기","정군기","경계기","경장기"].map(n => ({name:n,type:"1",cat:"군기"})),
  "시설A":[],
  "시설B":[{name:"장군 막사",type:"2-1",cat:"시설B"},{name:"말뚝",type:"2-2",cat:"시설B"},{name:"쇠사슬",type:"2-3",cat:"시설B"},{name:"선등영",type:"2-2",cat:"시설B"},{name:"초소",type:"2-3",cat:"시설B"},{name:"호분영",type:"2-1",cat:"시설B"}]
};

function getAdjustedPos(e, canvas) {
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches ? e.touches[0] : e;
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    return { x: (touch.clientX - rect.left) * scaleX, y: (touch.clientY - rect.top) * scaleY };
}

function drawHex(ctx, x, y, size, fill) {
  ctx.beginPath();
  for (var i = 0; i < 6; i++) {
    var angle = (Math.PI / 180) * (60 * i - 30);
    var px = x + size * Math.cos(angle), py = y + size * Math.sin(angle);
    if (i === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
  }
  ctx.closePath(); ctx.fillStyle = fill; ctx.fill(); ctx.strokeStyle = "rgba(0,0,0,0.2)"; ctx.stroke();
}

function drawTwoLineText(ctx, text, x, y, fontSize) {
  // 군기의 경우: 상단 한글(2자), 하단 한자(3자) -> 요청사항: 헥사곤 안에는 한글만 표시
  let kr = text.length === 3 && text.endsWith('기') ? text.substring(0, 2) : text;
  
  ctx.textAlign = "center"; ctx.textBaseline = "middle";
  ctx.fillStyle = "#fff"; 
  ctx.font = `bold ${fontSize}px sans-serif`;
  ctx.fillText(kr, x, y); // 한글만 정중앙에 출력
}

function drawShape(ctx, x, y, type, fill, isPalette, itemName, cells) {
  var dx = HEX_W / 2, dy = ROW_H;
  if(isPalette) {
      let offsetX_21 = (type === "2-1") ? -dx : 0;
      let pCells = [{x: x + offsetX_21, y: y}];
      if (type === "2-1") pCells.push({x: x + HEX_W + offsetX_21, y: y});
      if (type === "2-2") pCells.push({x: x + dx, y: y - dy});
      if (type === "2-3") pCells.push({x: x - dx, y: y - dy});
      if (type === "3-1") pCells.push({x: x - HEX_W, y: y}, {x: x + HEX_W, y: y});
      if (type === "3-2") pCells.push({x: x - dx, y: y + dy}, {x: x + dx, y: y + dy});
      if (type === "3-3") pCells.push({x: x - dx, y: y - dy}, {x: x + dx, y: y - dy});
      let minY = Math.min(...pCells.map(p => p.y)), maxY = Math.max(...pCells.map(p => p.y));
      let currentCenterY = (minY + maxY) / 2, offsetY = y - currentCenterY; 
      pCells.forEach(p => drawHex(ctx, p.x, p.y + offsetY, HEX_SIZE, fill));
      let cX = x, cY = y;
      let nameSize = (window.innerWidth <= 768) ? 18 : 16;
      if (type === "1") { drawTwoLineText(ctx, itemName, cX, cY, nameSize); return; }
      const img = loadedImages[itemName];
      if (img) {
          let iw = 65 * 0.9, ih = 65 * 0.9;
          if (type.startsWith("3")) { iw = 110 * 0.9; ih = 110 * 0.9; }
          if (type === "3-1") { iw = 175 * 0.9; ih = 60 * 0.9; }
          if (type === "2-1") { iw = 120 * 0.9; ih = (img.height/img.width) * iw; }
          else if (type.startsWith("2")) { iw = 95 * 0.9; ih = (img.height/img.width) * iw; }
          let imgAdjY = 0, imgAdjX = 0;
          if(type === "3-2") imgAdjY = -12; 
          if(type === "2-2") { imgAdjY = -8; imgAdjX = dx/2; }
          if(type === "2-3") { imgAdjY = -8; imgAdjX = -dx/2; }
          ctx.drawImage(img, cX - iw/2 + imgAdjX, cY + imgAdjY - ih/2, iw, ih);
      }
      return;
  }
  if (cells && cells.length > 0) {
      let sX = 0, sY = 0;
      cells.forEach(c => {
          let row = boards[currentBoard][c.r], ox = (1100 - row.length * HEX_W) / 2;
          let px = ox + c.c * HEX_W + HEX_W / 2, py = 50 + c.r * ROW_H;
          sX += px; sY += py; drawHex(ctx, px, py, HEX_SIZE, fill);
      });
      let cX = sX / cells.length, cY = sY / cells.length;
      let boardNameSize = (window.innerWidth <= 768) ? 18 : 16;
      if (type === "1") { drawTwoLineText(ctx, itemName, cX, cY, boardNameSize); return; }
      const img = loadedImages[itemName];
      if (img) {
          let iw = 65 * 0.9; 
          if (type.startsWith("3")) iw = (type === "3-1") ? (175 * 0.9) : (110 * 0.9);
          if (type === "2-1") iw = 120 * 0.9;
          else if (type.startsWith("2")) iw = 95 * 0.9;
          let ih = (img.height / img.width) * iw, imgAdjY = 0;
          ctx.drawImage(img, cX - iw/2, cY - ih/2 + imgAdjY, iw, ih);
      }
  }
}

function renderBoard() {
  if(!bctx) return;
  bctx.clearRect(0, 0, 1100, 360);
  var board = boards[currentBoard], defenseScore = 0;
  var dragCells = (draggingItem && draggingItem.snap) ? getTargetCells(draggingItem.snap.r, draggingItem.snap.c, draggingItem.type) : [];
  for (var r = 0; r < board.length; r++) {
    var row = board[r], ox = (1100 - row.length * HEX_W) / 2;
    for (var c = 0; c < row.length; c++) {
      if (row[c] === "X") continue;
      var isPlaced = placedItems.some(it => it.cells.some(cell => cell.r === r && cell.c === c));
      var isHover = dragCells.some(cell => cell.r === r && cell.c === c), finalFill;
      if (isPlaced) { finalFill = `rgba(${parseInt(colors[row[c]].slice(1,3),16)},${parseInt(colors[row[c]].slice(3,5),16)},${parseInt(colors[row[c]].slice(5,7),16)},0.35)`; defenseScore++; }
      else if (isHover) { finalFill = "rgba(255,255,255,0.4)"; }
      else { finalFill = colors[row[c]] || "#333"; }
      var px = ox + c * HEX_W + HEX_W/2, py = 50 + r * ROW_H;
      drawHex(bctx, px, py, HEX_SIZE, finalFill);
      if (["좌","중","우"].indexOf(row[c]) !== -1) {
        bctx.fillStyle = "rgba(255,255,255,0.5)"; bctx.textAlign = "center"; bctx.textBaseline = "middle"; bctx.font = "bold 14px sans-serif";
        bctx.fillText(row[c], px, py);
      }
    }
  }
  placedItems.forEach(it => {
    let details = getItemDetails(it.name);
    if(details) drawShape(bctx, 0, 0, details.type, "rgba(0,0,0,0)", false, it.name, it.cells);
  });
  if (draggingItem && draggingItem.snap) drawShape(bctx, 0, 0, draggingItem.type, "rgba(0,0,0,0)", false, draggingItem.name, dragCells);
  bctx.fillStyle = "#e6e6fa"; bctx.font = "bold 25px sans-serif"; bctx.textAlign = "right"; bctx.textBaseline = "bottom"; bctx.globalAlpha = 0.6;
  bctx.fillText("Made by. 예슈화、", 1090, 350); bctx.globalAlpha = 1.0;
  document.getElementById("defense-score").innerText = "방어치 : " + defenseScore;
}

function renderPalette() {
  if(!pctx) return;
  pctx.clearRect(0, 0, 1100, 220); 
  var items = currentCategory === "시설A" ? commonA.concat(boardSpecificA[currentBoard]) : categoryItems[currentCategory];
  var baseHeight, rowSpacing, textOffset;
  if(currentCategory === "군기") {
      baseHeight = 50; rowSpacing = 90; textOffset = 40; // 군기 위치 조정
  } else {
      baseHeight = 85; rowSpacing = 110; textOffset = 65;
  }
  const itemsPerRow = 6, spacing = 1100 / (itemsPerRow + 1);
  items.forEach((it, i) => {
    var x = spacing + (i % itemsPerRow) * spacing, y = baseHeight + Math.floor(i / itemsPerRow) * rowSpacing;
    drawShape(pctx, x, y, it.type, "#333", true, it.name);
    
    // 팔레트 하단 이름 표시 (군기 포함 모두 한글(한자) 적용)
    let fontSize = (window.innerWidth <= 768) ? 14 : 14;
    pctx.fillStyle = "#fff"; pctx.font = `bold ${fontSize}px sans-serif`; pctx.textAlign = "center";
    let fullName = `${it.name}(${hanjaMap[it.name] || ''})`;
    pctx.fillText(fullName, x, y + textOffset); 
    
    it.px = x; it.py = y;
  });
}

function renderEffects() {
  var base = formationEffects[currentBoard], extras = { "좌": [], "중": [], "우": [] };
  placedItems.forEach(item => {
    var opt = itemOptions[item.name] || "";
    var area = {};
    item.cells.forEach(c => {
      var color = boards[currentBoard][c.r][c.c];
      if (color === "초") area["좌"] = true; if (color === "빨") area["중"] = true; if (color === "파") area["우"] = true;
    });
    // 효과창 리스트 이름에 한글(한자) 적용
    let nameWithHanja = `${item.name}(${hanjaMap[item.name] || ''})`;
    if (area["좌"]) extras["좌"].push({n:nameWithHanja, d:opt});
    if (area["중"]) extras["중"].push({n:nameWithHanja, d:opt});
    if (area["우"]) extras["우"].push({n:nameWithHanja, d:opt});
  });
  function fH(bE, eL, c) {
    var h = `<div class='formation-base' style='color:${c};'>[진형] ${bE}</div>`;
    eL.forEach(k => h += `<div class='opt-item'><span class='opt-name'>${k.n}</span><span class='opt-desc'>${k.d}</span></div>`);
    return h;
  }
  document.getElementById("effect-left").innerHTML = fH(base[0], extras["좌"], "#2ecc71");
  document.getElementById("effect-center").innerHTML = fH(base[1], extras["중"], "#e74c3c");
  document.getElementById("effect-right").innerHTML = fH(base[2], extras["우"], "#3498db");
}

function toggleEffect(id) { if (window.innerWidth <= 768) document.getElementById(id).classList.toggle('collapsed'); }
function undoLast() { if(placedItems.length > 0) { placedItems.pop(); renderBoard(); renderEffects(); } }
function getCellFromPos(mx, my) {
  var board = boards[currentBoard];
  for (var r = 0; r < board.length; r++) {
    var ox = (1100 - board[r].length * HEX_W) / 2;
    for (var c = 0; c < board[r].length; c++) {
      if (board[r][c] === "X") continue;
      if (Math.sqrt((mx - (ox + c * HEX_W + HEX_W / 2))**2 + (my - (50 + r * ROW_H))**2) < HEX_SIZE) return { r: r, c: c };
    }
  } return null;
}
function getTargetCells(r, c, type) {
  var cells = [{r:r, c:c}], isL = boards[currentBoard][r].length === 10;
  var nb = { al: isL ? {r:r-1, c:c-1} : {r:r-1, c:c}, ar: isL ? {r:r-1, c:c} : {r:r-1, c:c+1}, bl: isL ? {r:r+1, c:c-1} : {r:r+1, c:c}, br: isL ? {r:r+1, c:c} : {r:r+1, c:c+1} };
  if (type === "2-1") cells.push({r:r, c:c+1});
  else if (type === "2-2") cells.push(nb.ar);
  else if (type === "2-3") cells.push(nb.al);
  else if (type === "3-1") cells = [{r:r, c:c-1}, {r:r, c:c}, {r:r, c:c+1}];
  else if (type === "3-2") cells = [{r:r, c:c}, nb.bl, nb.br];
  else if (type === "3-3") cells = [{r:r, c:c}, nb.al, nb.ar];
  return cells;
}
function getItemDetails(name) { return categoryItems["군기"].concat(categoryItems["시설B"], commonA, boardSpecificA[currentBoard]).find(i => i.name === name); }

window.onload = function() {
  boardCanvas = document.getElementById("board"); bctx = boardCanvas.getContext("2d");
  paletteCanvas = document.getElementById("palette"); pctx = paletteCanvas.getContext("2d");
  const startDrag = (e, isPalette) => {
    const pos = getAdjustedPos(e, isPalette ? paletteCanvas : boardCanvas);
    if (isPalette) {
      var items = currentCategory === "시설A" ? commonA.concat(boardSpecificA[currentBoard]) : categoryItems[currentCategory];
      for (var i = 0; i < items.length; i++) {
        if (Math.sqrt((items[i].px - pos.x)**2 + (items[i].py - pos.y)**2) < 60) {
          draggingItem = JSON.parse(JSON.stringify(items[i])); isMovingFromBoard = false; break;
        }
      }
    } else {
      var snap = getCellFromPos(pos.x, pos.y);
      if (snap) {
        for(var i=0; i<placedItems.length; i++) {
          if(placedItems[i].cells.some(c => c.r === snap.r && c.c === snap.c)) {
            draggingItem = JSON.parse(JSON.stringify(getItemDetails(placedItems[i].name)));
            draggingItem.mx = pos.x; draggingItem.my = pos.y; isMovingFromBoard = true;
            placedItems.splice(i, 1); renderBoard(); renderEffects(); return;
          }
        }
      }
    }
  };
  const moveDrag = (e) => { if (draggingItem) { const pos = getAdjustedPos(e, boardCanvas); draggingItem.mx = pos.x; draggingItem.my = pos.y; draggingItem.snap = getCellFromPos(pos.x, pos.y); renderBoard(); } };
  const endDrag = () => {
    if (!draggingItem) return;
    if (draggingItem.snap) {
      var snap = draggingItem.snap;
      if(placedItems.some(i => i.name === draggingItem.name)) alert("이미 배치되었습니다.");
      else {
          var cells = getTargetCells(snap.r, snap.c, draggingItem.type), canP = true, board = boards[currentBoard];
          for(var i=0; i<cells.length; i++) {
            var p = cells[i];
            if (!board[p.r] || !board[p.r][p.c] || board[p.r][p.c] === "X" || ["좌","중","우"].indexOf(board[p.r][p.c]) !== -1) canP = false;
            for(var j=0; j<placedItems.length; j++) if(placedItems[j].cells.some(c => c.r === p.r && c.c === p.c)) canP = false;
          }
          if (canP) placedItems.push({ name: draggingItem.name, cells: cells, cat: draggingItem.cat });
      }
    }
    draggingItem = null; isMovingFromBoard = false; renderBoard(); renderEffects();
  };
  boardCanvas.addEventListener('mousedown', (e) => startDrag(e, false));
  paletteCanvas.addEventListener('mousedown', (e) => startDrag(e, true));
  window.addEventListener('mousemove', moveDrag);
  window.addEventListener('mouseup', endDrag);
  const opt = { passive: false };
  boardCanvas.addEventListener('touchstart', (e) => { startDrag(e, false); if(draggingItem) e.preventDefault(); }, opt);
  paletteCanvas.addEventListener('touchstart', (e) => { startDrag(e, true); if(draggingItem) e.preventDefault(); }, opt);
  window.addEventListener('touchmove', (e) => { if(draggingItem) { e.preventDefault(); moveDrag(e); } }, opt);
  window.addEventListener('touchend', (e) => { if(draggingItem) endDrag(); }, opt);
  setBoard('안행진');
};

function setBoard(n) { currentBoard = n; placedItems = []; renderBoard(); renderPalette(); renderEffects(); }
function selectCategory(c) { currentCategory = c; renderPalette(); }
function clearBoard() { if(confirm("초기화 하시겠습니까?")) { placedItems = []; renderBoard(); renderEffects(); } }
</script>
<script>
  // 1. 마우스 오른쪽 클릭 방지
  document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
  });

  // 2. 단축키 차단 (F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U 등)
  document.onkeydown = function(e) {
    if (e.keyCode == 123) { // F12
      return false;
    }
    if (e.ctrlKey && e.shiftKey && (e.keyCode == 'I'.charCodeAt(0) || e.keyCode == 'J'.charCodeAt(0))) {
      return false;
    }
    if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { // 소스보기 단축키
      return false;
    }
  };
</script>
</body>
</html>